# AI設定・モデル使用状況 包括的ドキュメント

## 📊 概要

このドキュメントは、FIND to DO ブログシステムにおけるAI関連の全設定、使用モデル、トークン制限、コスト分析を包括的にまとめたものです。運用・開発・コスト管理に必要な全情報を網羅しています。

**作成日**: 2025年6月24日  
**対象システム**: FIND to DO ブログ生成システム  
**主要AI**: Google Gemini API

---

## 🤖 使用AIモデル詳細

### 主要AIモデル構成

| モデル名 | 用途 | 優先度 | 性能特性 |
|----------|------|--------|----------|
| **gemini-2.0-flash** | メイン記事生成 | 第1優先 | 高速・コスト効率 |
| **gemini-1.5-pro** | 高品質要求時 | 第2優先 | 高精度・多機能 |
| **gemini-2.0-flash-lite** | フォールバック | 第3優先 | 軽量・安定性重視 |

### モデル選択ロジック
```typescript
// src/lib/gemini.ts:65
const modelName = modelOverride || process.env.GEMINI_MODEL || GEMINI_MODELS.FLASH;

// フォールバック階層
1. 引数指定モデル (modelOverride)
2. 環境変数設定 (GEMINI_MODEL)
3. デフォルト (gemini-2.0-flash)

// 過負荷時のカスケードフォールバック
gemini-1.5-pro → gemini-2.0-flash → gemini-2.0-flash-lite
```

---

## ⚙️ API設定・パラメータ詳細

### 基本生成設定
```typescript
// src/lib/gemini.ts:32-37
const defaultGenerationConfig = {
  temperature: 0.7,        // 創造性レベル (0.0-1.0)
  topP: 0.9,              // 多様性制御 (0.0-1.0)  
  topK: 40,               // 候補トークン数制限
  maxOutputTokens: 6000,  // 出力トークン上限
};
```

#### パラメータ詳細解説

| パラメータ | 設定値 | 説明 | 影響 |
|------------|--------|------|------|
| **temperature** | 0.7 | 出力の創造性・ランダム性 | 0.7は適度な創造性を保持 |
| **topP** | 0.9 | 累積確率による語彙制限 | 0.9で自然な文章生成 |
| **topK** | 40 | 候補トークンの上位K個に制限 | 40で適切な語彙範囲確保 |
| **maxOutputTokens** | 6000 | 1回の生成での最大出力 | 5000-7000文字記事に対応 |

### 安全性設定
```typescript
// src/lib/gemini.ts:4-22
const safetySettings = [
  {
    category: HarmCategory.HARM_CATEGORY_HARASSMENT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  }
];
```

#### 安全性レベル解説
- **ブロックレベル**: MEDIUM_AND_ABOVE (中程度以上をブロック)
- **対象カテゴリ**: ハラスメント、ヘイトスピーチ、性的コンテンツ、危険コンテンツ
- **影響**: 教育的・技術的コンテンツ生成には影響なし

---

## 🕒 タイムアウト・リトライ設定

### タイムアウト階層
```typescript
// 複数レベルのタイムアウト設定

1. Gemini API基本タイムアウト
   - src/lib/gemini.ts:40
   - API_TIMEOUT = 60000ms (60秒)

2. 記事生成タイムアウト  
   - src/lib/article.ts:207
   - timeout = 45000ms (45秒)

3. ニュース取得タイムアウト
   - src/lib/trends.ts:166  
   - timeout = 10000ms (10秒)
```

### リトライ設定
```typescript
// src/lib/article.ts:10-14
const MAX_RETRIES = 3;              // 最大試行回数
const RETRY_DELAY = 5000;           // 再試行間隔(ms)
const TOKEN_SIZES = [3500, 4000, 4500, 6000]; // 段階的トークン調整
```

#### リトライ戦略
1. **第1試行**: 3500トークン出力制限
2. **第2試行**: 4000トークン出力制限  
3. **第3試行**: 4500トークン出力制限
4. **最終試行**: 6000トークン出力制限

---

## 💰 コスト分析・使用量詳細

### 現在の使用量推計

| 項目 | 数値 | 単位 |
|------|------|------|
| **記事生成頻度** | 1回/日 | - |
| **プロンプト入力** | ~2,000 | トークン/記事 |
| **出力生成** | ~6,000 | トークン/記事 |
| **1記事総計** | ~8,000 | トークン |
| **月間使用量** | 240,000 | トークン |
| **年間使用量** | 2,880,000 | トークン |

### コスト推計 (Gemini 2.0 Flash基準)

#### 月間コスト
```
入力トークン: 60,000 × $0.075/1M = $0.0045
出力トークン: 180,000 × $0.3/1M = $0.0540
月額合計: $0.0585 (約8.77円)
```

#### 年間コスト
```
年額合計: $0.70 (約105円)
```

### モデル別料金比較

| モデル | 入力料金/1M | 出力料金/1M | 月額推計 |
|--------|-------------|-------------|----------|
| **gemini-2.0-flash** | $0.075 | $0.30 | $0.0585 |
| **gemini-1.5-pro** | $1.25 | $5.00 | $0.975 |
| **gemini-2.0-flash-lite** | $0.075 | $0.30 | $0.0585 |

**コスト効率**: flash-liteとflashが同額で最安、proは約17倍高額

---

## 🔧 環境変数・設定ファイル

### 必須環境変数
```bash
# .env ファイル
GEMINI_API_KEY=your_api_key_here    # 必須: Gemini APIキー
GEMINI_MODEL=gemini-2.0-flash       # オプション: デフォルトモデル指定
```

### パッケージ依存関係
```json
// package.json 主要AI関連
{
  "@google/generative-ai": "^0.24.0",  // Gemini API公式SDK
  "axios": "^1.8.4",                   // HTTP通信(News API用)
  "cheerio": "^1.0.0",                 // HTML/XML解析(RSS用)
  "dotenv": "^16.5.0",                 // 環境変数管理
}
```

### 実行スクリプト
```json
// package.json scripts
{
  "generate": "tsx src/scripts/generate-blog.ts",      // ブログ生成
  "rss:regenerate": "tsx src/scripts/regenerate-rss.ts" // RSS再生成
}
```

---

## 📈 パフォーマンス・品質設定

### 生成品質制御
```typescript
// 品質に影響する主要設定

1. プロンプト長制限
   - 現在: 約2000トークン
   - 最適範囲: 1500-3000トークン

2. 出力長制御  
   - 目標: 5000-7000文字
   - トークン上限: 6000トークン
   - 実効率: 約80% (4800-5600文字)

3. リトライによる品質向上
   - 失敗時の段階的トークン増加
   - 最大3回までの自動再試行
```

### パフォーマンス指標

| 指標 | 現在値 | 目標値 | 状況 |
|------|--------|--------|------|
| **生成成功率** | ~70% | 95% | 🔴 改善必要 |
| **平均生成時間** | 30-60秒 | 45秒以内 | 🟡 許容範囲 |
| **品質スコア** | ~50% | 85% | 🔴 改善必要 |
| **API可用性** | ~95% | 99% | 🟡 良好 |

---

## 🛡️ エラーハンドリング・フォールバック

### エラー分類と対応

#### 1. API制限・過負荷エラー
```typescript
// src/lib/gemini.ts:92-121
if (error.status === 429) {
  // レート制限: 待機後リトライ
} else if (error.status === 503) {
  // 過負荷: 下位モデルへフォールバック
  // PRO → FLASH → FLASH_LITE
}
```

#### 2. タイムアウト・ネットワークエラー  
```typescript
// src/lib/gemini.ts:89-91
if (error.message === 'API_TIMEOUT') {
  // 45秒タイムアウト: プロンプト最適化推奨
}
```

#### 3. 認証エラー
```typescript
// src/lib/gemini.ts:54-56
if (!key) {
  throw new Error('GEMINI_API_KEY is not set');
}
```

### フォールバック階層
```
1次: gemini-2.0-flash (メイン)
2次: gemini-2.0-flash-lite (過負荷時)
3次: エラー返却 (全モデル不可時)
```

---

## 🔍 監視・デバッグ設定

### ログ出力設定
```typescript
// 主要ログポイント
1. モデル選択: console.log(`使用モデル: ${modelName}`)
2. 生成時間: console.log(`API呼び出し時間: ${time}ms`)  
3. エラー詳細: console.error('Gemini API error:', error)
4. リトライ状況: console.log(`試行 ${attempt}/${MAX_RETRIES}`)
```

### デバッグツール
```bash
# API接続テスト
npm run test-gemini

# 手動記事生成
npm run generate

# RSS再生成  
npm run rss:regenerate
```

---

## 📊 使用状況統計 (推計)

### 日次パターン
```
0:00 - 自動記事生成 (GitHub Actions)
├── プロンプト生成: ~5秒
├── API呼び出し: ~30-60秒  
├── 後処理: ~5秒
└── 総時間: ~45-70秒
```

### 月次トークン消費パターン
```
第1週: 56,000トークン (7記事)
第2週: 56,000トークン (7記事)  
第3週: 56,000トークン (7記事)
第4週: 72,000トークン (9記事) # 月末調整
月計: 240,000トークン (30記事)
```

---

## 🚀 最適化推奨事項

### 短期最適化 (1週間)
1. **タイムアウト調整**: 45秒→60秒に延長
2. **リトライ間隔**: 5秒→3秒に短縮
3. **温度パラメータ**: 0.7→0.6に調整（安定性向上）

### 中期最適化 (1ヶ月)  
1. **アダプティブトークン**: 記事タイプ別のトークン調整
2. **キャッシュ機能**: よく使われるプロンプトパターンの保存
3. **バッチ処理**: 複数記事の並列生成

### 長期最適化 (3ヶ月)
1. **ファインチューニング**: 専用モデルの検討
2. **ハイブリッド生成**: 複数AIの組み合わせ
3. **自動品質評価**: AI品質判定システム

---

## 🔒 セキュリティ・コンプライアンス

### APIキー管理
- **保存場所**: 環境変数 (.env)
- **アクセス制御**: サーバーサイドのみ
- **ローテーション**: 手動 (推奨: 3ヶ月毎)

### データプライバシー
- **入力データ**: ニュース記事タイトル・公開情報のみ
- **出力データ**: ブログ記事・公開予定情報
- **個人情報**: 取り扱いなし

### コンプライアンス
- **利用規約準拠**: Google Gemini利用規約に準拠
- **安全性設定**: 有害コンテンツの自動ブロック設定済み
- **監査ログ**: API呼び出しログの保持

---

## 📋 トラブルシューティング

### よくある問題

#### 1. 記事生成失敗
**症状**: 記事が生成されない、エラーで停止
**原因**: API制限、過負荷、ネットワーク問題
**対処**: 
```bash
# API接続確認
npm run test-gemini

# 手動実行で詳細確認
npm run generate
```

#### 2. 品質低下
**症状**: 記事の内容が浅い、構造が不安定
**原因**: プロンプト設定、トークン制限
**対処**: プロンプト見直し、トークン上限調整

#### 3. コスト増加
**症状**: 予想より高いAPI使用料
**原因**: 記事生成頻度増加、長文生成
**対処**: 生成頻度調整、出力トークン制限

### 緊急時対応

#### API障害時
1. **status確認**: Google Cloud Statusページ確認
2. **フォールバック**: 手動記事作成への切り替え
3. **通知**: 開発チームへの障害報告

#### 予算超過時
1. **停止**: 自動生成の一時停止
2. **分析**: 使用量ログの詳細確認  
3. **調整**: 生成パラメータの最適化

---

## 📈 将来計画・拡張予定

### Phase 1: 安定化 (1ヶ月)
- エラーハンドリング強化
- 品質指標の導入
- 監視ダッシュボード構築

### Phase 2: 効率化 (3ヶ月)
- マルチモデル対応
- 並列処理の実装
- コスト最適化機能

### Phase 3: 高度化 (6ヶ月)
- 専用ファインチューニング
- リアルタイム品質調整
- 自動A/Bテスト機能

---

## 📞 サポート・連絡先

**技術責任者**: 開発チームリーダー  
**AI運用担当**: フルスタックエンジニア  
**コスト管理**: プロジェクトマネージャー

**緊急時連絡**: API障害・予算超過時は即座に報告  
**定期レビュー**: 月次のAI使用状況レビュー実施

---

**ドキュメント作成日**: 2025年6月24日  
**最終更新日**: 2025年6月24日  
**次回更新予定**: AI設定変更時またはモデルアップデート時  
**バージョン**: 1.0