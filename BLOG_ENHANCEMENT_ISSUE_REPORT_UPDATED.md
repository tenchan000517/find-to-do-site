# 🚨 ブログ生成システム修正依頼書（更新版）

**作成日**: 2025年6月22日  
**更新日**: 2025年6月22日 16:40  
**担当**: Claude Code  
**次回担当者**: [新しいエンジニア名]  
**緊急度**: 高  

## 📋 Phase 3+拡張の実装状況

### ✅ **完了した修正内容**
1. **ソース記載機能**: Google Newsから情報源を取得し、記事末尾に「参考文献・情報源」セクションを追加 ✓
2. **SEO最適化機能**: フロントマターに詳細なSEOメタデータを自動生成 ✓
3. **品質向上**: 関連ニュース数増加（2→3件）、トークン制限拡大（1500-4000→3500-6000） ✓
4. **プロンプト構造正常化**: 自然な記事構成への変更 ✓
5. **参考情報セクション確実生成**: システム側自動追加機能 ✓
6. **ディレクトリ英語化**: 日本語ディレクトリ名を英語に変更 ✓

### 🚨 **新たに発見された問題点**

## 1. **MDX構文エラー：記事冒頭の無効なコードブロック**
**問題**: AI生成記事の冒頭に無効な ```コードブロック が挿入される
- **影響**: MDXコンパイルエラーでページが表示されない
- **発生場所**: フロントマター直後（13行目）
- **エラー内容**: `[next-mdx-remote] error compiling MDX: Could not parse expression with acorn`

**問題のあるパターン**:
```markdown
---
title: "記事タイトル"
---

```
# 記事タイトル

記事内容...
```

**修正が必要なファイル**:
- `/content/blog/ai-technology/2025-06-22-aittir-japan-2025elsevier.md`
- `/content/blog/ai-technology/2025-06-22-llmgemma-3n.md`

## 2. **Next.jsビルドエラー：ルーティング競合**
**問題**: `/blog`ページと`/blog/[slug]`ページの競合によりビルドが失敗
- **エラー**: `Error: The provided export path '/blog' doesn't match the '/blog/[slug]' page.`
- **原因**: 静的サイト生成でのパス競合

## 🔧 **修正が必要な箇所**

### 優先度1: MDX構文エラーの修正

#### **A. AIプロンプトでの対策**
**ファイル**: `src/lib/prompt.ts`
**問題**: AIが記事冒頭に不正なコードブロックを生成している

**追加すべき指示**:
```typescript
## 重要：マークダウン構文の注意事項
- 記事冒頭に不要なコードブロック（```）を挿入しないでください
- フロントマター（---）の直後は必ず空行を1行入れてからタイトル（#）を記述してください
- コードブロックは技術的な説明が必要な箇所でのみ使用してください
```

#### **B. 後処理での対策**
**ファイル**: `src/lib/article.ts` の `fixCodeBlockLanguages` 関数

**問題のある処理**:
```typescript
// 2. 言語未指定のコードブロックをtsxに変換
fixedContent = fixedContent.replace(/```(?!\w)/g, "```tsx");
```

**修正案**:
```typescript
// 記事冒頭の不正なコードブロックを除去
fixedContent = fixedContent.replace(/^(---[\s\S]*?---\s*)\n```\n(# .+)/m, '$1\n$2');

// 言語未指定のコードブロックをtsxに変換（記事冒頭以外）
fixedContent = fixedContent.replace(/```(?!\w)(?![\s\S]*?^# )/gm, "```tsx");
```

### 優先度2: Next.jsルーティング競合の解決

#### **選択肢A: /blogページの削除**
```bash
rm /mnt/c/find-to-do-site/src/app/blog/page.tsx
```
- 記事一覧は `/news-blog` で代用

#### **選択肢B: ルーティング構造の変更**
- `/blog` → `/articles` または `/posts` に変更
- 既存のURLを維持する場合はリダイレクト設定が必要

### 優先度3: RSS URLの修正

**ファイル**: `src/lib/rss.ts`
**問題**: カテゴリ名が日本語から英語に変更されたため、RSSのURLが変更される

**修正例**:
```typescript
// カテゴリマッピング関数を追加
function getCategoryUrl(category: string): string {
  const mapping: Record<string, string> = {
    'AI技術': 'ai-technology',
    'プログラミング': 'programming',
    'ウェブ開発': 'web-development',
    'キャリア': 'career',
    'ビジネス': 'business'
  };
  return mapping[category] || category.toLowerCase();
}
```

## 📁 **ディレクトリ構造の変更結果**

### **変更前**:
```
content/blog/
├── ai技術/
├── ウェブ開発/
├── キャリア/
├── ビジネス/
└── プログラミング/
```

### **変更後**:
```
content/blog/
├── ai-technology/
├── web-development/
├── career/
├── business/
└── programming/
```

## 🧪 **テスト手順**

### **修正後の確認項目**:
1. **MDXコンパイル**: `npm run build` でエラーが発生しないこと
2. **記事表示**: 個別記事ページが正常に表示されること
3. **RSS生成**: RSSフィードが正常に更新されること
4. **カテゴリ表示**: ブログカード等でカテゴリが正しく表示されること
5. **新規記事生成**: `npm run generate` で正常な記事が生成されること

### **テストコマンド**:
```bash
# 型チェック
npx tsc --noEmit

# ビルドテスト
npm run build

# 記事生成テスト
npm run generate

# 開発サーバー起動テスト
npm run dev
```

## 📞 **連絡事項**

### **実装済み機能**:
- ✅ プロンプト構造の正常化
- ✅ 参考情報セクションの自動生成
- ✅ ディレクトリ英語化（日本語→英語）
- ✅ カテゴリマッピング機能
- ✅ エラーハンドリング強化

### **残存課題**:
- ❌ MDX構文エラー（記事冒頭の```）
- ❌ Next.jsビルドエラー（ルーティング競合）
- ⚠️ RSS URL更新（カテゴリ英語化対応）

### **技術的メモ**:
- フロントマターの `category` フィールドが表示に使用されるため、既存記事の表示は影響なし
- `src/lib/mdx.ts` の `getAllPosts` 関数は全ディレクトリを検索するため、英語ディレクトリも問題なく読み込み可能
- 新規記事は英語ディレクトリに保存され、適切な日本語カテゴリ名がフロントマターに設定される

---

**重要**: 修正完了後は必ず本番環境でのビルドテストを実行し、既存記事の表示とRSSフィードの動作を確認してください。

**次回修正時の推奨アプローチ**: 
1. MDX構文エラーの根本的な解決（AIプロンプト改善 + 後処理強化）
2. Next.jsルーティング構造の明確化
3. URL変更に伴うSEO影響の最小化